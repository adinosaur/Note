IP协议学习笔记
=========
IP协议的设计思路是：向上提供简单灵活的、无连接、尽最大努力交付的数据包服务。

因此如果需要可靠的（无差错）的网络服务需要在IP协议之上自行提供（如TCP）。

###IP协议的作用

互联网将许多个不同的网络通过路由器连接起来，这些不同的网络可能有不同的寻址方案，不同的最大分组长度等等。
通过IP协议可以向上层屏蔽底层的异构性，让上层用户（传输层）使用起来像是一个统一的网络。

###相关协议
有几个协议与IP协议相关：

* 地址解析协议ARP
* 逆地址解析协议RARP
* 网际控制报文协议ICMP
* 网际组管理协议IGMP


###工作原理
IP数据报通过中间路由器转发到合适的网络，而路由器根据自身内存维护的路由表把相应的数据报转发给“更靠近目的地”的路由器，不断循环这个过程最后将数据报转发至目的网络。

linux系统在内核维护一个的路由表，可以通过`route`命令查询。


###IP地址与硬件地址

* ARP：根据给定的IP地址，找出相应的物理地址。
* RARP：根据给定的物理地址找出相应的IP地址。

每一个主机都在内存里维护一个ARP高速缓存，保存着本地局域网上的各主机和路由器的IP地址到硬件地址的映射表。
可以用`arp`命令查看。

###路由器的分组转发算法
IP层会根据路由器主机的内核维护的路由表对接受到的IP数据报进行分组转发。转发规则如下：

1. 从IP数据报的头部获得目的IP地址D，得出目的的网络地址N。
2. 若N是与该路由器直接相连的网络，则进行直接交付（具体是将目的主机地址D通过ARP转换为相应的物理地址，把数据报封装成MAC帧，并发送）。
3. 否则通过查询路由器内核的路由表，如果路由表有IP地址为D的特定路由，则把数据报转发给该路由器。
4. 否则如果路由表中有网络号为N的下一跳路由，则转发数据报至该路由。
5. 否则如果路由表有默认路由则转发至默认路由。
6. 否则报告转发出错。





